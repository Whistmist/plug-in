var notification=false,playerTabs={},cidHackType={};function getFileData(e,t){xmlhttp=new XMLHttpRequest;xmlhttp.open("GET",e,false);xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4&&xmlhttp.status==200){if(typeof t=="function")t(xmlhttp.responseText)}};xmlhttp.send()}function getUrlVars(e){var t=[],i;var n=e.slice(e.indexOf("?")+1).split("&");for(var a=0;a<n.length;a++){i=n[a].split("=");t.push(i[0]);t[i[0]]=i[1]}return t}function searchBilibili(e){chrome.tabs.create({url:"http://www.bilibili.com/search?keyword="+e.selectionText})}function notifyAllTabs(e){chrome.windows.getAll({populate:true},function(t){t.forEach(function(t){t.tabs.forEach(function(t){chrome.tabs.sendMessage(t.id,e)})})})}function setIcon(){chrome.browserAction.setIcon({path:"imgs/icon-19.png"})}function updateAll(){notifyAllTabs({command:"update"});setIcon()}function enableAll(){setOption("enabled",true);updateAll()}function disableAll(){setOption("enabled",false);updateAll()}function checkDynamic(){chrome.cookies.get({url:"http://interface.bilibili.com/nav.js",name:"DedeUserID"},function(e){if(e===null)return false;else if(getOption("dynamic")=="on"){getFileData("http://interface.bilibili.com/nav.js",function(e){chrome.cookies.get({url:"http://interface.bilibili.com/nav.js",name:"_cnt_dyn"},function(e){if(typeof e!=="undefined"){if(e.value>getOption("updates")){if(notification)chrome.notifications.clear("bh-"+notification,function(){});notification=(new Date).getTime();chrome.notifications.create("bh-"+notification,{type:"basic",iconUrl:"imgs/icon-32.png",title:chrome.i18n.getMessage("noticeficationTitle"),message:chrome.i18n.getMessage("followingUpdateMessage").replace("%n",e.value),isClickable:false},function(){})}setOption("updates",e.value);if(getOption("updates")==0){chrome.browserAction.setBadgeText({text:""})}else{chrome.browserAction.setBadgeText({text:getOption("updates")})}}})})}})}function getCid(e,t){if(typeof cidCache[e]!="undefined"){t(cidCache[e],true);return true}getFileData("http://api.bilibili.com/view?type=json&appkey=95acd7f6cc3392f3&id="+e+"&page=1",function(i){i=JSON.parse(i);if(typeof i.code!="undefined"&&i.code==-503){setTimeout(function(){getCid(e,t)},1e3)}else{if(typeof i.cid=="number"){cidCache[e]=i.cid;localStorage.setItem("cidCache",JSON.stringify(cidCache))}t(i.cid,false)}});return true}chrome.extension.onMessage.addListener(function(e,t,i){switch(e.command){case"init":i({replace:getOption("replace"),html5:getOption("html5"),version:version});return true;case"cidHack":playerTabs[t.tab.id]=e.cid;cidHackType[e.cid]=e.type;i();return true;case"getOption":i({value:getOption(e.key)});return true;case"enableAll":enableAll();i({result:"ok"});return true;case"disableAll":disableAll();i({result:"ok"});return true;case"getCSS":if(getOption("enabled")=="true"||getOption("ad")!="keep")i({result:"ok",css:getCSS(e.url)});else i({result:"disabled"});return true;case"getVideoInfo":getFileData("http://api.bilibili.com/view?type=json&appkey=95acd7f6cc3392f3&id="+e.avid+"&page="+e.pg,function(e){e=JSON.parse(e);i({videoInfo:e})});return true;case"getDownloadLink":var n={download:"http://interface.bilibili.com/playurl?platform=bilihelper&otype=json&appkey=95acd7f6cc3392f3&cid="+e.cid+"&quality=4&type="+getOption("dlquality"),playback:"http://interface.bilibili.com/playurl?platform=bilihelper&otype=json&appkey=95acd7f6cc3392f3&cid="+e.cid+"&quality=4&type=mp4"};if(e.cidHack==2){var n={download:"https://bilibili.guguke.net/playurl.json?cid="+e.cid+"&type="+getOption("dlquality"),playback:"https://bilibili.guguke.net/playurl.json?cid="+e.cid+"&type=mp4"}}getFileData(n["download"],function(e){e=JSON.parse(e);if(getOption("dlquality")=="mp4"){i({download:e,playback:e,dlquality:getOption("dlquality"),rel_search:getOption("rel_search")})}else{getFileData(n["playback"],function(t){t=JSON.parse(t);i({download:e,playback:t,dlquality:getOption("dlquality"),rel_search:getOption("rel_search")})})}});return true;case"getMyInfo":getFileData("http://api.bilibili.com/myinfo",function(e){e=JSON.parse(e);if(typeof e.code==undefined)e.code=200;i({code:e.code||200,myinfo:e})});return true;case"searchVideo":var a=e.keyword;getFileData("http://api.bilibili.com/search?type=json&appkey=95acd7f6cc3392f3&keyword="+encodeURIComponent(a)+"&page=1&order=ranklevel",function(e){e=JSON.parse(e);if(e.code==0){i({status:"ok",result:e.result[0]})}else{i({status:"error",code:e.code,error:e.error})}});return true;case"checkComment":getFileData("http://www.bilibili.com/feedback/arc-"+e.avid+"-1.html",function(e){var t=e.indexOf('<div class="no_more">');if(t>=0){i({banned:true})}else{i({banned:false})}});return true;default:i({result:"unknown"});return false}});if(localStorage.getItem("enabled")==null){enableAll()}if(getOption("contextmenu")=="on"){chrome.contextMenus.create({title:chrome.i18n.getMessage("searchBili"),contexts:["selection"],onclick:searchBilibili})}setIcon();checkDynamic();chrome.alarms.create("checkDynamic",{periodInMinutes:5});chrome.alarms.onAlarm.addListener(function(e){switch(e.name){case"checkDynamic":checkDynamic();return true;default:return false}});chrome.webRequest.onBeforeRequest.addListener(function(e){chrome.tabs.sendMessage(e.tabId,{command:"error"})},{urls:["http://comment.bilibili.com/1272.xml"]});chrome.webRequest.onHeadersReceived.addListener(function(e){var t={};console.log(e);if(getOption("replace")=="on"){if(e.url.indexOf("retry=1")<0){t.redirectUrl=e.url+"&retry=1"}}console.log(t);return t},{urls:["http://g3.letv.cn/vod/v2/*"]},["blocking"]);chrome.webRequest.onHeadersReceived.addListener(function(e){var t={};if(getOption("replace")=="on"&&e.url.indexOf("cid="+playerTabs[e.tabId])>0){playerTabs[e.tabId]=false;var i=getUrlVars(e.url);if(i["cid"]){if(cidHackType[i["cid"]]==1){t.redirectUrl="http://interface.bilibili.com/playurl?platform=bilihelper&cid="+i["cid"]+"&appkey=95acd7f6cc3392f3"}else if(cidHackType[i["cid"]]==2){t.redirectUrl="https://bilibili.guguke.net/playurl.xml?cid="+i["cid"]}}}return t},{urls:["http://interface.bilibili.com/playurl?cid*","http://interface.bilibili.com/playurl?accel=1&cid=*"]},["blocking"]);chrome.webRequest.onHeadersReceived.addListener(function(e){var t=e.responseHeaders,n={};if(e.statusLine=="HTTP/1.1 302 Moved Temporarily"&&getOption("replace")=="on"){n.responseHeaders=[];var a="";for(i in t){if(t[i].name.toLowerCase()!="location"){n.responseHeaders.push(t[i])}else{a=t[i]["value"]}}n.responseHeaders.push({name:"Set-Cookie",value:"redirectUrl="+encodeURIComponent(a)})}else{n.responseHeaders=t}return n},{urls:["http://www.bilibili.com/video/av*"]},["responseHeaders","blocking"]);